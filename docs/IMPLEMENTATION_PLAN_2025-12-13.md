# Storyteller Implementation Plan - 2025-12-13

## Overview

This comprehensive plan addresses all reported issues and feature requests from the 2025-12-13 session. It was generated by analyzing the codebase with 5 parallel sub-agents.

---

## Issue Summary

| # | Issue | Priority | Effort | Status |
|---|-------|----------|--------|--------|
| 1 | Audio clicking at end of voice lines | P2 | Low | Planned |
| 2 | Text formatting (too bunched) | P1 | Low | Planned |
| 3 | Begin Chapter 1 loading state | P2 | Low | Planned |
| 4 | Karaoke word highlighting | P1 | Medium | Planned |
| 5 | SFX timing redesign | P0 | High | Planned |
| 6 | SFX intensity levels | P1 | Medium | Planned |
| 7 | SFX admin panel | P2 | Medium | Planned |
| 8 | Story recording/caching | P0 | High | Planned |
| 9 | Codebase simplification | P1 | Ongoing | Planned |

---

## 1. Audio Clicking Fix

### Root Cause
Raw MP3 buffer concatenation at `elevenlabs.js:1391` using `Buffer.concat()` without crossfade. The system has `audioAssembler.js` with FFmpeg crossfade capabilities but it's NOT being used.

### Solution
Replace `Buffer.concat` with call to `assembleMultiVoiceAudio()` from audioAssembler.js.

### Files to Change
| File | Lines | Change |
|------|-------|--------|
| `server/services/elevenlabs.js` | 1-20 | Add audioAssembler import |
| `server/services/elevenlabs.js` | 1385-1391 | Replace Buffer.concat with assembleMultiVoiceAudio() |

### Implementation
```javascript
// In elevenlabs.js, replace:
const combinedBuffer = Buffer.concat(audioBuffers);

// With:
import { assembleMultiVoiceAudio, ASSEMBLY_PRESETS } from './audioAssembler.js';

const assemblySegments = audioBuffers.map((audio, idx) => ({
  audio,
  speaker: emotionEnhancedSegments[idx].speaker,
  type: emotionEnhancedSegments[idx].speaker === 'narrator' ? 'narrator' : 'character',
  duration: segmentResults[idx]?.durationMs || 0
}));

const assemblyResult = await assembleMultiVoiceAudio(assemblySegments, {
  ...ASSEMBLY_PRESETS.natural,
  outputFormat: 'mp3'
});
const combinedBuffer = assemblyResult.audio;
```

---

## 2. Text Formatting (Kindle-style)

### Root Cause
Missing proper typography CSS - no max-width constraint, no paragraph spacing, inconsistent line-height.

### Solution
Add Kindle-like CSS classes for readable text.

### Files to Change
| File | Change |
|------|--------|
| `client/src/index.css` | Add `.story-text-readable` class |
| `client/src/components/BookPageLayout.jsx` | Apply readable classes |
| `client/src/components/StoryBookView.jsx` | Apply max-width and spacing |

### CSS to Add (index.css)
```css
.story-text-readable {
  font-family: Georgia, 'Times New Roman', serif;
  font-size: 1.125rem;
  line-height: 1.8;
  letter-spacing: 0.02em;
  max-width: 70ch;
  margin: 0 auto;
  color: #e8e3d8;
}

.story-text-readable p {
  margin-bottom: 1.5em;
  text-indent: 1.5em;
}

.story-text-readable p:first-of-type {
  text-indent: 0;
}
```

---

## 3. Begin Chapter 1 Loading State

### Root Cause
`handleAudioReady` in `useLaunchSequence.js` sets `isReadyToPlay` to `false` when audio-ready event arrives, causing LaunchScreen to unmount BEFORE audio actually plays.

### Solution
Add `isAudioQueued` state that bridges the gap between audio-ready and audio-playing.

### Files to Change
| File | Lines | Change |
|------|-------|--------|
| `client/src/hooks/useLaunchSequence.js` | 132-133 | Add `isAudioQueued` state |
| `client/src/hooks/useLaunchSequence.js` | 879-883 | Modify `handleAudioReady` |
| `client/src/pages/Story.jsx` | 171, 1882 | Use `isAudioQueued` in condition |

### Implementation
```javascript
// useLaunchSequence.js
const [isAudioQueued, setIsAudioQueued] = useState(false);

// In handleAudioReady, instead of resetting everything:
setIsAudioQueued(true);

// Story.jsx condition change:
{(isGenerating || launchActive || isCountdownActive || isReadyToPlay || (isAudioQueued && !isPlaying)) ? (
```

---

## 4. Karaoke Word Highlighting

### Current State
Word highlighting exists but needs:
- Current LINE shading (subtle background on entire line being read)
- Reliable word sync with audio

### Solution
Add line detection based on DOM positions, apply subtle shading to current line.

### Files to Change
| File | Change |
|------|--------|
| `client/src/components/BookPageLayout.jsx` | Add line detection, apply current-line shading |
| `client/src/index.css` | Add `.karaoke-current-line` CSS |

### Implementation
```javascript
// Line detection in BookPageLayout.jsx
const [lineRanges, setLineRanges] = useState([]);

useEffect(() => {
  // Calculate line breaks based on word DOM positions
  const ranges = [];
  let lineStart = 0;
  let lastY = null;

  wordRefs.current.forEach((el, idx) => {
    const rect = el.getBoundingClientRect();
    if (lastY !== null && Math.abs(rect.top - lastY) > 10) {
      ranges.push({ start: lineStart, end: idx - 1 });
      lineStart = idx;
    }
    lastY = rect.top;
  });
  ranges.push({ start: lineStart, end: words.length - 1 });
  setLineRanges(ranges);
}, [words]);

// Apply to words:
const isOnCurrentLine = currentLine && idx >= currentLine.start && idx <= currentLine.end;
// Add class: isOnCurrentLine && 'bg-night-700/30'
```

---

## 5. SFX Timing Redesign

### Root Cause
All SFX have `trigger_at_seconds: 0` hardcoded at `orchestrator.js:1523`. Timing is semantic ("beginning", "middle") not numeric.

### Solution
1. Add pre/sync/post categorization to SFX detection
2. Calculate actual trigger positions based on word timings
3. Schedule SFX playback on client with delays

### Files to Change
| File | Lines | Change |
|------|-------|--------|
| `server/services/orchestrator.js` | 1523 | Calculate actual trigger times |
| `server/services/sfxAgents.js` | 543-566 | Add pre/sync/post to prompts |
| `client/src/pages/Story.jsx` | 362-370 | Schedule SFX by trigger time |

### SFX Categories
- **pre**: Ambient sounds BEFORE narration (rain, engine hum)
- **sync**: Action sounds at specific text moment
- **post**: Atmosphere fade-out after scene

### Implementation
```javascript
// orchestrator.js - calculate timing
async calculateSfxTriggerPositions(sceneSfx, wordTimings, sceneText) {
  return sceneSfx.map(sfx => {
    if (sfx.category === 'pre') return { ...sfx, trigger_at_seconds: -3 };
    if (sfx.category === 'post') return { ...sfx, trigger_at_seconds: wordTimings.total_duration_ms / 1000 };
    // For sync, find trigger text position
    const triggerIndex = sceneText.toLowerCase().indexOf(sfx.trigger?.toLowerCase() || '');
    // Map to word timing...
    return { ...sfx, trigger_at_seconds: calculatedTime };
  });
}

// Story.jsx - schedule playback
for (const sfx of sfxList) {
  const delay = (sfx.trigger_at_seconds || 0) * 1000;
  setTimeout(() => playIndividualSfx(sfx), delay);
}
```

---

## 6. SFX Intensity Levels

### Root Cause
- Teacher validation rejects sounds but doesn't replace them
- Prompts don't enforce minimum counts
- Current targets: low(4-6), medium(6-10), high(10-18)

### Solution
Enforce minimums after teacher validation, strengthen prompts.

### Files to Change
| File | Lines | Change |
|------|-------|--------|
| `server/services/sfxAgents.js` | 1248-1286 | Add enforcement after validation |
| `server/services/sfxAgents.js` | 414-464 | Strengthen high-level prompts |

### Implementation
```javascript
// After teacher validation
const levelTargets = { low: 4, medium: 6, high: 10 };
const minRequired = levelTargets[sfxLevel];

if (finalSfxList.length < minRequired && sfxLevel === 'high') {
  const additionalSounds = await requestMoreAmbientSounds(
    sceneText, context, minRequired - finalSfxList.length
  );
  finalSfxList.push(...additionalSounds);
}
```

---

## 7. SFX Admin Panel

### Requirements
- View all cached sounds with playback
- Show tags, usage count, generation date
- Pre-generate sounds by prompt
- Delete/flag annoying sounds
- Search/filter by tags

### Database Changes
```sql
ALTER TABLE sfx_cache ADD COLUMN tags TEXT[] DEFAULT '{}';
ALTER TABLE sfx_cache ADD COLUMN category VARCHAR(50);
ALTER TABLE sfx_cache ADD COLUMN is_flagged BOOLEAN DEFAULT FALSE;
ALTER TABLE sfx_cache ADD COLUMN user_rating FLOAT DEFAULT NULL;
CREATE INDEX idx_sfx_cache_tags ON sfx_cache USING GIN(tags);
```

### New Files
- `client/src/pages/AdminSFX.jsx`
- `server/routes/admin.js` - extend with SFX endpoints

---

## 8. Story Recording/Caching System

### Requirements
- Dual-track storage (narration + SFX separately)
- Token-free playback from cached files
- SFX toggle in real-time
- Word-level timestamps for karaoke
- WAV/MP3 export

### Good News
Word timings already exist via ElevenLabs `textToSpeechWithTimestamps()` at elevenlabs.js:1575!

### Database Schema
```sql
CREATE TABLE recording_tracks (
    id UUID PRIMARY KEY,
    recording_id UUID REFERENCES story_recordings(id),
    track_type VARCHAR(20) NOT NULL, -- 'narration', 'sfx', 'combined'
    file_path VARCHAR(500) NOT NULL,
    file_url VARCHAR(500) NOT NULL,
    format VARCHAR(10) DEFAULT 'mp3',
    duration_seconds FLOAT NOT NULL,
    combined_word_timings JSONB, -- For karaoke
    status VARCHAR(20) DEFAULT 'pending',
    created_at TIMESTAMP DEFAULT NOW()
);
```

### New Files
- `server/services/trackGenerator.js` - Audio concatenation with FFmpeg
- `client/src/components/EnhancedRecordingPlayer.jsx` - Dual-track playback

### Dependencies
- `fluent-ffmpeg` - FFmpeg wrapper for Node.js

---

## 9. Codebase Simplification

### Major Duplications Found

| Duplication | Locations | Lines |
|-------------|-----------|-------|
| Voice IDs (JBFq..., N2lV...) | 14+ files | ~50 |
| Style normalization | 5 locations | ~15 |
| JSON parsing | 3 implementations | ~140 |
| Tag stripping | 2 implementations | ~10 |
| Audience multiplier | 2 locations | ~20 |

### Large Files to Split
- `orchestrator.js` - 1,949 lines
- `openai.js` - 2,500+ lines
- `Story.jsx` - 2,100+ lines

### Priority Refactoring
1. Create `server/constants/voices.js` for voice IDs
2. Create `normalizeStyleValue()` utility
3. Consolidate JSON parsing to single implementation
4. Split orchestrator.js into focused modules

### Estimated Impact
~335 lines removed through consolidation

---

## Implementation Phases

### Phase 1: Quick Wins (1-2 days)
- [ ] Audio clicking fix (use audioAssembler.js)
- [ ] Text formatting CSS
- [ ] Begin Chapter loading state

### Phase 2: Core Features (3-5 days)
- [ ] Karaoke line highlighting
- [ ] SFX timing redesign
- [ ] SFX intensity fix

### Phase 3: Recording System (5-7 days)
- [ ] Database migration for tracks
- [ ] Track generator service
- [ ] Enhanced recording player
- [ ] Export functionality

### Phase 4: Admin & Polish (2-3 days)
- [ ] SFX admin panel
- [ ] Codebase simplification
- [ ] Documentation updates

---

## Testing Checklist

After each phase:
- [ ] Multi-voice narration plays without clicking
- [ ] Text is readable (proper spacing)
- [ ] Loading indicator persists until audio
- [ ] Karaoke highlights current word AND line
- [ ] SFX play at correct moments
- [ ] High SFX mode produces 10+ effects
- [ ] Recordings can be played token-free
- [ ] SFX can be toggled during playback
