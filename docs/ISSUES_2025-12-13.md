# Storyteller Issues & Feature Requests - 2025-12-13

This document tracks all reported issues and planned improvements from the 2025-12-13 session.

## Priority Legend
- **P0**: Critical - Blocks usage
- **P1**: High - Major UX issue
- **P2**: Medium - Notable improvement
- **P3**: Low - Nice to have

---

## 1. Audio Clicking Sound (P2)
**Status**: Open
**Type**: Bug

### Description
Slight clicking sound at the very end of voice-acted lines, before the Narrator or next speaker begins. Sounds like audio segments are being cut/spliced.

### Root Cause (Suspected)
Audio segment concatenation in `audioAssembler.js` - segments may not have proper fade-out or the audio buffers are being clipped.

### Fix Approach
- Add micro fade-out (5-10ms) at end of each audio segment
- Ensure audio segments have proper sample alignment
- Consider crossfade between segments

### Files to Investigate
- `server/services/audioAssembler.js`
- `server/services/elevenlabs.js`

---

## 2. Text Formatting - Too Bunched Up (P1)
**Status**: Open
**Type**: UX Bug

### Description
Story text is too dense/bunched up. Previously had better Kindle-like formatting with proper paragraph spacing, line height, and reading comfort.

### Requirements
- Increased line-height (1.6-1.8)
- Proper paragraph spacing (margin-bottom on paragraphs)
- Comfortable max-width for readability (~65-75 characters per line)
- Proper font size scaling for mobile/desktop
- Consider serif font for story content (better readability)

### Files to Investigate
- `client/src/pages/Story.jsx`
- `client/src/components/StoryBookView.jsx`
- `client/src/components/BookPageLayout.jsx`
- `client/src/index.css`

---

## 3. Karaoke Word Highlighting (P1)
**Status**: Open (Regression)
**Type**: Bug

### Description
Karaoke-style word highlighting worked once but hasn't worked since. The current line should have subtle shading and the spoken word should be highlighted.

### Requirements
- **Line highlighting**: Subtle background shading on the line being read
- **Word highlighting**: Clear highlight on the currently spoken word
- **Future**: User-configurable highlight colors
- Must sync with audio timestamps

### Technical Notes
- Need word-level timestamps from ElevenLabs TTS
- Store timestamps in `scene_word_timings` table (migration 009 exists)
- Real-time sync during playback

### Files to Investigate
- `client/src/components/ReadAlongPlayer.jsx`
- `server/services/elevenlabs.js` (word timing extraction)
- `database/migrations/009_scene_word_timings.sql`

---

## 4. Sound Effects Timing - Complete Redesign (P0)
**Status**: Open
**Type**: Feature/Bug

### Problems
1. **Poor timing**: SFX don't match when sound descriptions are spoken
2. **Missing pre-play**: Ambient sounds (rain, engine hum) should start BEFORE narration
3. **Annoying sounds**: Some generated sounds are unpleasant - need removal mechanism
4. **Intensity levels broken**: "LOTS" option (~10+ SFX) only generates ~6

### Requirements

#### 4a. Timing Architecture
- **Pre-narrative sounds**: Rain, engine hum, ambient should start before scene
- **Sync sounds**: Explosions, doors, footsteps sync with narration
- **Post-narrative sounds**: Fade-out ambient at scene end
- LLM should categorize each SFX as: `pre`, `sync`, `post`

#### 4b. Better LLM Passes
- First pass: Identify ALL sound opportunities in scene
- Second pass: Match to existing library sounds (by tag/description)
- Third pass: Only generate NEW sounds if no match found
- Fourth pass: Timing placement (pre/sync/post with character position)

#### 4c. Intensity Levels (Fix)
| Level | Name | Target SFX Count | Description |
|-------|------|------------------|-------------|
| 1 | Minimal | 2-3 per scene | Only critical sounds |
| 2 | Balanced | 5-7 per scene | Key moments |
| 3 | Immersive | 10-15 per scene | Rich soundscape |

#### 4d. Library-First Approach
- Search existing `sfx_cache` table by semantic similarity
- Tag-based matching (e.g., "rain", "footsteps", "door")
- Only call ElevenLabs SFX generation for truly new sounds
- Verify generated sounds ARE being saved to library

### Files to Investigate
- `server/services/soundEffects.js`
- `server/services/agents/sfxCoordinator.js`
- `server/routes/sfx.js`
- `client/src/components/SFXPlayer.jsx`

---

## 5. SFX Admin Panel (P2)
**Status**: Open
**Type**: Feature

### Requirements
- View all sounds in library with:
  - Audio preview/playback
  - Tags/description
  - Usage count
  - Generation date
- Pre-generate sounds by prompt
- Delete/flag annoying sounds
- Bulk tagging capabilities
- Search/filter by tags

### Technical Approach
- New route: `/admin/sfx`
- New component: `client/src/pages/AdminSFX.jsx`
- Leverage existing `server/routes/admin.js`

---

## 6. Story Recording/Caching System (P0)
**Status**: Open
**Type**: Feature

### Description
Record entire story for subsequent playback WITHOUT using API tokens. Eliminates re-generation costs.

### Requirements

#### 6a. Audio Recording
- Export complete story as WAV or MP3
- Separate track for SFX (toggle on/off in real-time)
- Separate track for narration/dialogue

#### 6b. Timestamp Storage
- Store word-level timestamps for karaoke sync
- Store SFX trigger points
- Enable read-along highlighting on cached playback

#### 6c. Playback Modes
- **Live**: Real-time TTS generation (current behavior)
- **Cached**: Play from stored audio files
- **Hybrid**: Use cached where available, generate new for choices

### Database Schema Additions
```sql
CREATE TABLE story_recordings (
  id UUID PRIMARY KEY,
  session_id UUID REFERENCES story_sessions(id),
  scene_sequence INTEGER,
  narration_audio_url TEXT,
  sfx_audio_url TEXT,
  combined_audio_url TEXT,
  word_timings JSONB,
  sfx_timings JSONB,
  created_at TIMESTAMP DEFAULT NOW()
);
```

### Files to Create/Modify
- `server/services/storyRecorder.js` (NEW)
- `server/routes/recordings.js` (expand)
- `database/migrations/015_story_recordings.sql` (NEW)

---

## 7. Begin Chapter 1 Button Loading State (P2)
**Status**: Open
**Type**: Bug

### Description
The "Begin Chapter 1" button shows loading indicator briefly but reverts to button state before audio actually starts playing. Loading should persist until audio plays.

### Requirements
- Show loading animation from button click until first audio chunk plays
- Consider showing generation progress stages
- Don't allow re-click during loading

### Files to Investigate
- `client/src/pages/Story.jsx`
- `client/src/components/LaunchScreen.jsx`
- Socket event handling for `audio-ready`

---

## 8. Codebase Simplification (P1)
**Status**: Ongoing
**Type**: Technical Debt

### Principles
1. **DRY**: Eliminate duplicate code across files
2. **Single Source of Truth**: One place for each piece of logic
3. **Smaller Files**: Break large files into focused modules
4. **Clear Naming**: Self-documenting function/variable names
5. **Remove Dead Code**: Delete unused functions, commented code
6. **Consolidate Constants**: Central config files for magic values

### Known Problem Areas
- Multiple tag-stripping implementations
- Duplicate socket event handlers
- Large orchestrator.js could be split
- Scattered configuration values

### Approach
- Each fix should also clean surrounding code
- Refactor as we go, not as separate passes
- Document architectural decisions

---

## Implementation Order (Recommended)

1. **Phase 1 - Quick Wins**
   - [ ] Text formatting (CSS changes)
   - [ ] Begin Chapter 1 loading state
   - [ ] Audio clicking fix

2. **Phase 2 - Core Features**
   - [ ] Karaoke highlighting
   - [ ] Story recording system
   - [ ] SFX timing redesign

3. **Phase 3 - Admin & Polish**
   - [ ] SFX admin panel
   - [ ] SFX intensity level fixes
   - [ ] Codebase simplification

---

## Notes for Claude Code Agents

When working on these issues:
1. Read related files thoroughly before making changes
2. Look for existing implementations that might be duplicated
3. Consider impact on other features
4. Update CLAUDE.md if architectural patterns change
5. Add logging for debugging where helpful
6. Write defensive code - validate inputs
7. Keep mobile-first approach

## Related Documentation
- `docs/FEATURES.md` - Current feature implementations
- `docs/LOGGING_STANDARDS.md` - Debug logging format
- `CLAUDE.md` - Project overview and key files
